name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate project structure
      run: |
        Write-Host "üîç Validating autoFilterWheel project structure..."

        # Check essential files exist
        $requiredFiles = @(
          "autoFilterWheel.sln",
          "autoFilterWheel/autoFilterWheel.csproj",
          "autoFilterWheel/autoFilterWheel Setup.iss",
          ".github/workflows/release-installer.yml"
        )

        $allValid = $true
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "‚úì $file - Found"
          } else {
            Write-Host "‚úó $file - Missing"
            $allValid = $false
          }
        }

        if ($allValid) {
          Write-Host "‚úÖ Project structure validation passed"
        } else {
          Write-Host "‚ùå Project structure validation failed"
          exit 1
        }
      shell: powershell

    - name: Validate Inno Setup script
      run: |
        Write-Host "üîç Validating Inno Setup configuration..."

        $issFile = "autoFilterWheel/autoFilterWheel Setup.iss"
        $content = Get-Content $issFile -Raw

        # Check for required sections and settings
        $checks = @{
          "OutputBaseFilename" = 'autoFilterWheelSetup'
          "AppName" = 'autoFilterWheel'
          "bin\Release\ASCOM.autoFilterWheel.exe" = 'relative path'
        }

        $allValid = $true
        foreach ($check in $checks.GetEnumerator()) {
          if ($content -match [regex]::Escape($check.Key)) {
            Write-Host "‚úì $($check.Key) - Found ($($check.Value))"
          } else {
            Write-Host "‚úó $($check.Key) - Missing or incorrect"
            $allValid = $false
          }
        }

        if ($allValid) {
          Write-Host "‚úÖ Inno Setup script validation passed"
        } else {
          Write-Host "‚ùå Inno Setup script validation failed"
          exit 1
        }
      shell: powershell